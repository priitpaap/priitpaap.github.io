## Jinja2 mallid

**Jinja2** on Ansible vaikimisi kasutatav mallimootor, millega saab dünaamiliselt luua konfiguratsioonifaile, skripte või muud sisu.

Mallid on tavalised tekstifailid, kus kasutatakse muutujate ja kontrolllausete süntaksit (nt if, for).

Faili laiend on tavaliselt `.j2`.

### Näide mallifailist

Fail `nginx.conf.j2`:

```jinja2
server {
    listen 80;
    server_name {{ server_name }};

    root {{ web_root }}/html;

    location / {
        index index.html;
    }
}
```

### Playbook, mis kasutab malli

```yaml
---
- name: NGINX konfiguratsiooni loomine mallist
  hosts: webservers
  become: yes
  vars:
    server_name: example.com
    web_root: /var/www
  tasks:
    - name: Loo konfiguratsioonifail mallist
      template:
        src: nginx.conf.j2
        dest: /etc/nginx/sites-available/default
      notify: Taaskäivita nginx

  handlers:
    - name: Taaskäivita nginx
      service:
        name: nginx
        state: restarted
```

### Selgitus

- Mallifaili muutujad (`{{ server_name }}` ja `{{ web_root }}`) asendatakse jooksutamise ajal nende väärtustega.
- `template:` moodul kopeerib mallifaili sihtmasinasse ja teeb asendused.
- `notify:` ja `handlers:` on viis teha teatud tegevus (nt teenuse taaskäivitamine) ainult siis, kui mallifaili sisu muutus.

---

## Jinja2 süntaksi põhitõed

- Muutuja: `{{ variable_name }}`
- Tingimus:
```jinja2
{% if use_ssl %}
listen 443 ssl;
{% else %}
listen 80;
{% endif %}
```
- Tsükkel:
```jinja2
{% for site in sites %}
server_name {{ site }};
{% endfor %}
```

---

## Head tavad muutujate ja mallide kasutamisel

- Testi malli `--check` ja `--diff` lipuga enne tootmiskeskkonnas kasutamist.
- Kasuta mallides idempotentsust – väldi juhuslikke dünaamilisi väärtusi, mis muudavad faili igal jooksutusel.

## Harjutus

1. Loo `templates/` kataloog ja sinna fail `demo.conf.j2`, mis sisaldab:
```jinja2
server {
    listen 80;
    server_name {{ server_name }};
    root {{ web_root }};
}
```
2. Loo playbook, mis kopeerib malli sihtmasinasse `/etc/nginx/sites-available/demo`.
3. Käivita playbook ja veendu, et fail on loodud õigete väärtustega.
4. Muuda `server_name` muutujat ja käivita playbook uuesti – vaata, kas fail muutus ja teenus taaskäivitati.

## Rohkem infot

- [Ansible Template Module](https://docs.ansible.com/ansible/latest/collections/ansible/builtin/template_module.html)
- [Jinja2 Documentation](https://jinja.palletsprojects.com/en/latest/templates/)
